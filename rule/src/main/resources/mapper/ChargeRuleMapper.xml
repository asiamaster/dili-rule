<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dili.rule.mapper.ChargeRuleMapper">
  <resultMap id="BaseResultMap" type="com.dili.rule.domain.ChargeRule">
    <!--
      WARNING - @mbg.generated
    -->
    <id column="id"  property="id" />
    <result column="original_id"  property="originalId" />
    <result column="market_id"  property="marketId" />
    <result column="business_type"  property="businessType" />
    <result column="group_id"  property="groupId" />
    <result column="charge_item"  property="chargeItem" />
    <result column="rule_name"  property="ruleName" />
    <result column="state"  property="state" />
    <result column="priority"  property="priority" />
    <result column="expire_start"  property="expireStart" />
    <result column="expire_end"  property="expireEnd" />
    <result column="action_expression"  property="actionExpression" />
    <result column="min_payment"  property="minPayment" />
    <result column="max_payment"  property="maxPayment" />
    <result column="remark"  property="remark" />
    <result column="revisable"  property="revisable" />
    <result column="operator_id"  property="operatorId" />
    <result column="operator_name"  property="operatorName" />
    <result column="create_time"  property="createTime" />
    <result column="modify_time"  property="modifyTime" />
    <result column="approver_id"  property="approverId" />
    <result column="approver_name"  property="approverName" />
    <result column="approval_time"  property="approvalTime" />
  </resultMap>

  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
    -->
    id, original_id, market_id, business_type, group_id, charge_item,
    rule_name, state, priority, expire_start, expire_end, action_expression, min_payment, max_payment,
    remark, revisable, operator_id, operator_name, create_time, modify_time, approver_id, 
    approver_name, approval_time
  </sql>

  <select id="listForPage" parameterType="com.dili.rule.domain.ChargeRule" resultType="com.dili.rule.domain.vo.ChargeRuleVo">
    SELECT cr.*,
    IFNULL(group_concat(
            CASE  when  json_length(ccv.val)>0 THEN  ccv.label ELSE null END 
            ), '--') AS conditionLabel
    FROM
    charge_rule cr
    LEFT JOIN charge_condition_val ccv ON cr.id = ccv.rule_id
    <include refid="QUERY_WHERE_CLAUSE" />
    GROUP BY  cr.id
    order by ${sortSql}
  </select>

  <!-- 联合查询计费规则列表  -->
  <sql id="QUERY_WHERE_CLAUSE">
    <where>
      <if test="marketId != null">
        and cr.market_id = #{marketId}
      </if>
      <if test="businessType != null and businessType !=''">
        and cr.business_type = #{businessType}
      </if>
      <if test="chargeItem != null and chargeItem !=''">
        and cr.charge_item = #{chargeItem}
      </if>
      <if test="state != null">
        and cr.state = #{state}
      </if>
      <if test="ruleName != null and ruleName !=''">
        and cr.rule_name like concat('', #{ruleName}, '%')
      </if>
      <if test="operatorId != null and operatorId !=''">
        and cr.operator_id = #{operatorId}
      </if>
      <if test="isBackup != null">
        and cr.is_backup = #{isBackup}
      </if>
    </where>
  </sql>

  <insert id="insertBy" parameterType="com.dili.rule.domain.ChargeRule" useGeneratedKeys="true" keyProperty="id">
    <selectKey keyProperty="id" resultType="long" order="AFTER">
      SELECT LAST_INSERT_ID();
    </selectKey>
    INSERT INTO charge_rule (
        original_id,
        market_id,
        business_type,
        group_id,
        charge_item,
        rule_name,
        state,
        priority,
        expire_start,
        expire_end,
        action_expression,
        min_payment,
        max_payment,
        remark,
        revisable,
        operator_id,
        operator_name,
        approver_id,
        approver_name,
        approval_time
    )
    SELECT
		#{originalId},
        #{marketId},
        #{businessType},
        #{groupId},
        #{chargeItem},
        #{ruleName},
        #{state},
        IFNULL( MAX( priority ), 0 )+ 1,
        #{expireStart},
        #{expireEnd},
        #{actionExpression},
        #{minPayment},
        #{maxPayment},
        #{remark},
        #{revisable},
        #{operatorId},
        #{operatorName},
        #{approverId},
        #{approverName},
        #{approvalTime}
	    FROM charge_rule where market_id=#{marketId} and business_type=#{businessType} AND charge_item =#{chargeItem}
  </insert>

</mapper>