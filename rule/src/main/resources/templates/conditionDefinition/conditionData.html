<#bs4Body>

<div class="container-fluid">
    <input type="hidden" id="definitionId" value="${conditionDefinition.id}">
    <div class="table-wrap row justify-content-between">
        <div id="popupDiv" class="col-8">

        </div>

        <div class="table-showlist checkedShow col-3">
            <table class="table table-bordered table-hover table-condensed" id="selectedItem">
                <tr>
                    <th>${conditionDefinition.label!}</th>
                </tr>
            </table>
        </div>
    </div>
</div>
</#bs4Body>
<script type="text/javascript" src="${contextPath}/resources/js/underscore-min.js"></script>
<script>
    function addSelectedItem(key, text) {
        $('.checkedShow .table').append('<tr class="remove-btn" data-id="' + key + '"><td>' + text + '<i class="fa fa-times  float-right" aria-hidden="true"></i></td></tr>');
    }
    function removeSelectedItemByKey(key) {
        console.info('removeSelectedItem')
    }
    var choice = parent.window.choiceTarget;
    //debugger
    var checkedids = (choice.data('checkedids') ? choice.data('checkedids') : []).filter(function (v, i) {
        return $.trim(v) !== '';
    });
    var checkedtexts = (choice.data('checkedids') ? choice.parents('.input-group').find('input[name="checkedtexts"]').val().split(',') : []).filter(function (v, i) {
        return $.trim(v) !== '';
    });
//    debugger
    var conditionData = {
        checkedData: {
            idList: checkedids,
            textList: checkedtexts
        },
        unconfirmedData: {
            idList: [],
            textList: [],
        },
        unconfirmedBatchData: {
            batched: false,
            idList: [],
            textList: [],
        },
        removableData: {
            idList: [],
            textList: [],
        }
    }
    /**
     * 批量增加未确认选择数据
     * @param {type} idList
     * @param {type} textList
     * @returns {undefined}
     */
    function addUnconfirmedListData(idList, textList) {
        // conditionData.unconfirmedBatchData.batched = true;
        // conditionData.unconfirmedBatchData.idList = idList;
        // conditionData.unconfirmedBatchData.textList = textList;
        if(_.isArray(idList)&&_.isArray(textList)&&idList.length===textList.length){
            for(var i in idList){
                var id=idList[i];
                var text=textList[i];
                addUnconfirmedData(id,text);
            }
        }else{
            console.error("批量选择的数据长度或者类型错误")
        }
    }
    /**
     * 增加未确认数据到列表
     * @param {type} id
     * @param {type} text
     * @returns {undefined}
     */
    function addUnconfirmedData(id, text) {
        var index=conditionData.removableData.idList.indexOf(id);
        if(_.isNumber(index)&&index>-1){
            conditionData.removableData.idList=_.chain(conditionData.removableData.idList).filter((v,i)=>i!=index).value();
            conditionData.removableData.textList=_.chain(conditionData.removableData.textList).filter((v,i)=>i!=index).value();
        }
        var indexInCheckedData=conditionData.checkedData.idList.indexOf(id);
        var indexInUnconfirmedData=conditionData.unconfirmedData.idList.indexOf(id);
        if(indexInCheckedData>-1&&indexInUnconfirmedData>-1){
            conditionData.unconfirmedData.idList=_.chain(conditionData.unconfirmedData.idList).filter((v,i)=>i!=index).value();
            conditionData.unconfirmedData.textList=_.chain(conditionData.unconfirmedData.textList).filter((v,i)=>i!=index).value();
        }else if(indexInCheckedData==-1&&indexInUnconfirmedData==-1){
            conditionData.unconfirmedData.idList.push($.trim(id+''))
            conditionData.unconfirmedData.textList.push(text)
        }else{

        }
        // console.info(conditionData);

    }
    /**
     * 增加要被删除数据到列表
     * @param {type} id
     * @param {type} text
     * @returns {undefined}
     */
    function addRemovableData(id, text) {
        var index=conditionData.unconfirmedData.idList.indexOf(id);
        if(index>-1){
            conditionData.unconfirmedData.idList=_.chain(conditionData.unconfirmedData.idList).filter((v,i)=>i!=index).value();
            conditionData.unconfirmedData.textList=_.chain(conditionData.unconfirmedData.textList).filter((v,i)=>i!=index).value();
        }
        var index=_.chain(conditionData.checkedData.idList).indexOf(id).value();
        if(index!=-1){
            conditionData.removableData.idList.push($.trim(id+''))
            conditionData.removableData.textList.push(text)
        }
        // console.info(conditionData);
    }


    /**
     * 合并并返回最终数据
     * @returns {conditionData.checkedData}
     */
    function confirmConditionData() {

        $.each(conditionData.unconfirmedData.idList, function (i, id) {
            if ($.inArray(id, conditionData.checkedData.idList) < 0) {
                conditionData.checkedData.idList.push(id);
                conditionData.checkedData.textList.push(conditionData.unconfirmedData.textList[i]);
            }
        });
        $.each(conditionData.removableData.idList, function (i, id) {
            var index = $.inArray(id, conditionData.checkedData.idList);
            if (index >= 0) {
                conditionData.checkedData.idList.splice(index, 1);
                conditionData.checkedData.textList.splice(index, 1);
            }
        })

        //id不能为空数据(空值处理)
        conditionData.checkedData.idList = $.makeArray(conditionData.checkedData.idList).filter(function (v, i) {
            if ($.type(v) == 'string') {
                return v != '';
            }
            return true;
        });
        console.info(conditionData);
        return conditionData.checkedData;
    }

    /* 选择项 子父页面的存储 处理  */
    $(document).ready(function () {
        let definitionId = $('#definitionId').val();
        loadAjaxTable(definitionId);
        $.each(conditionData.checkedData.idList, function (k, ele) {
            $('body').find('.checkboxWrap [data-id="' + ele + '"]').find(':checkbox').prop('checked',true);
            if (!$('.checkedShow .table [data-id="' + ele + '"]').length) {
                $('.checkedShow .table').append('<tr class="remove-btn" data-id="' + ele + '"><td>' + conditionData.checkedData.textList[k] + '<i class="fa fa-times  float-right" aria-hidden="true"></i></td></tr>');
            }
        });
    });

    /**
     * 根据条件定义，动态加载表格
     * @param definitionId
     * @param params
     */
    function loadAjaxTable(definitionId, params) {
        let data = {};
        $.extend(data, {'definitionId': definitionId});
        $.extend(data, params);
        let json = JSON.stringify(data);
        let html = $.ajax({
            type: "POST",
            url: "${contextPath}/conditionDefinition/popupPage.action",
            data: json,
            contentType: "application/json",
            dataType: "json",
            async: false,
        }).responseText;
        $("#popupDiv").html(html);
    }


</script>
